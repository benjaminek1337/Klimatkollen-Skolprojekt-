@{
    ViewData["Title"] = "Privacy Policy";
}
<h1>BENJAMINS PRIVATA KARTOR OCH HEMLIGA EXPERIMENT</h1>

<div id="map" style="height: 550px; width:100%; border-radius: 8px; box-shadow: 3px 7px 5px #888888"></div>
<div id="inputs">
    <br />
    <input class="form-control" type="text" value="" placeholder="Latitud..." id="lat" />
    <input class="form-control" type="text" value="" placeholder="Longitud..." id="long" />
    <br />
    <input class="form-control" type="text" placeholder="Fritextsök område..." id="areaTextBox" />
    <button class="btn btn-primary" onclick="GetLatLongFromString()">Sök</button>
    <select name="Län" id="areas" class="form-control">
        <option>Välj område att bevaka</option>
    </select>
</div>

<script>
    var map, marker;

    //API-nyckel
    var key = "AIzaSyBagdhMKVaEPqLco2PxO2NCSTPYeU_T4gU"

    //Metod för att ta in text från textbox och ta ut latlng utifrån det
    function GetLatLongFromString() {
        var areaString = document.getElementById("areaTextBox").value;
        var lat, long;
        let url = "https://maps.googleapis.com/maps/api/geocode/json?address=" + areaString + "&region=swe&key=" + key;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log(url);
                console.log(data);
                lat = data.results[0].geometry.location.lat;
                long = data.results[0].geometry.location.lng;
                console.log(lat, long);

                GetAreasJson(lat, long);
                GetLatLongFromTextArea(lat, long);

            })
            .catch(error => console.warn(error.message));

    }

    //Metod för att tömma droplist
    function removeOptions(selectbox) {
        var i;
        for (i = selectbox.options.length - 1; i >= 0; i--) {
            selectbox.remove(i);
        }
    }

    //Metod som hämtar områden kopplade till inskickad latlng och lägger dessa i droplist
    function GetAreasJson(_lat, _lng) {
        var select = document.getElementById("areas");
        removeOptions(select);
        var lat = _lat;
        var lng = _lng;

        let url = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat + "," + lng + "&key="
            + key;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                let parts = data.results[0].address_components;
                parts.forEach(part => {
                    if (part.types.includes("administrative_area_level_1")
                        || part.types.includes("locality")
                        || part.types.includes("postal_town")
                        || part.types.includes("transit_station")
                        || part.types.includes("county")
                    ) {
                        var option = document.createElement("option");
                        option.setAttribute("id", "option");
                        option.text = part.long_name;
                        select.add(option);
                    }
                });
            })
            .catch(error => console.warn(error.message));
    }


    $(document).ready(function () {

        //Metod för att dra igång kartan
        function myMap(lat, long) {
            var myCenter = new google.maps.LatLng(lat, long);
            var mapCanvas = document.getElementById("map");
            var latInput, longInput;

            var mapOptions = {
                center: myCenter,
                zoom: 12,
                streetViewControl: false,
                mapTypeControl: true,
                zoomControl: false,
                scrollwheel: true
            };
            //Skapar kartan, plockar enhetens position (vid godkännande) och lägger markern på plats
            //Kallar även på metod för att hämta områden kopplade till latlng 
            map = new google.maps.Map(mapCanvas, mapOptions);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    latInput = document.getElementById("lat").value = position.coords.latitude;
                    longInput = document.getElementById("long").value = position.coords.longitude;

                    marker = new google.maps.Marker({
                        position: { lat: latInput, lng: longInput },
                        map: map,
                        draggable: true
                    });
                    marker.addListener('click', function () {
                        map.setCenter(marker.getPosition());
                    });
                    marker.addListener('dragend', function () {
                        document.getElementById("lat").value = marker.getPosition().lat();
                        document.getElementById("long").value = marker.getPosition().lng();
                    });

                    map.setCenter(marker.getPosition());
                    GetAreasJson(latInput, longInput);
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
            infoWindow.open(map);
        }

        //Dessa rader ser till att markern är flyttbar med klick
        google.maps.event.addDomListener(window, 'load', myMap(67.85426620914679, 20.227949203380874));

        map.addListener('click', function (event) {
            marker.setPosition(event.latLng);
            var lat = document.getElementById("lat").value = marker.getPosition().lat();
            var long = document.getElementById("long").value = marker.getPosition().lng();
            GetAreasJson(lat, long);
        });


    });

    //Kod för att flytta marker till angivet område och centrera kartan där
    function GetLatLongFromTextArea(lat, long) {
        var latlng;
        latlng = new google.maps.LatLng(lat, long);
        marker.setPosition(latlng);
        map.setCenter(marker.getPosition());
        document.getElementById("lat").value = lat;
        document.getElementById("long").value = long;
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBagdhMKVaEPqLco2PxO2NCSTPYeU_T4gU&callback=initMap"
        async defer></script>
